version: '3.8'

# This Docker Compose file orchestrates the backend, frontend, and a reverse proxy.

services:
  # The FastAPI backend service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file:
      # Loads environment variables from the .env file in the backend directory.
      # Ensure this file contains the database URL, secret key, etc.
      - backend/.env
    volumes:
      # Mounts the host's 'uploads' directory into the container at /app/uploads
      # This ensures that uploaded files are persisted even if the container is removed.
      - ./uploads:/app/uploads
    networks:
      - app-network
    # No ports are exposed to the host, as traffic is routed through Nginx.

  # The Nuxt.js frontend service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    networks:
      - app-network
    # No ports are exposed to the host, as traffic is routed through Nginx.

  # The Nginx reverse proxy service, which acts as the entry point to the application
  nginx:
    image: nginx:1.25-alpine
    ports:
      # Maps port 80 on the host to port 80 in the container.
      # This is the main entry point for all traffic.
      - "80:80"
    volumes:
      # Mounts the custom Nginx configuration file.
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      # Ensures that Nginx starts after the backend and frontend services.
      - backend
      - frontend
    networks:
      - app-network

  # MySQL Database Service
  db:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_DATABASE: 'app_db'
      # Development credentials
      MYSQL_USER: 'dev_user'
      MYSQL_PASSWORD: 'dev_password'
      MYSQL_ROOT_PASSWORD: 'dev_root_password'
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - app-network

  # phpMyAdmin Service (Obfuscated Access)
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    restart: always
    environment:
      PMA_HOST: db
      PMA_USER: dev_user
      PMA_PASSWORD: dev_password
      # Important for reverse proxy with subpath
      PMA_ABSOLUTE_URI: /sys_db_admin_x9zp2/
    networks:
      - app-network

# Defines the network that allows services to communicate with each other.
networks:
  app-network:
    driver: bridge

volumes:
  db-data:
