server {
    listen 80;
    server_name localhost;

    # 設定上傳檔案大小限制 (需配合後端與 PHP 設定)
    client_max_body_size 20M;

    # 前端 (Nuxt 3)
    location / {
        proxy_pass http://frontend:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $http_host;
        proxy_cache_bypass $http_upgrade;

        # [新增] 移除前端送出的 CSP Header，解決端口不符問題
        proxy_hide_header Content-Security-Policy;

        # [新增] 動態替換前端代碼中可能寫死的 URL
        sub_filter_once off;
        sub_filter_types application/javascript text/javascript text/css application/json;
        sub_filter 'http://localhost:8000' 'http://localhost:8081';
        sub_filter 'http://localhost/api' 'http://localhost:8081/api';
    }

    # 後端 API (FastAPI)
    location /api/v1/ {
        # 注意: 這裡對應 docker-compose.yml 中的 service name "backend"
        proxy_pass http://backend:8000/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $http_host;
        proxy_cache_bypass $http_upgrade;
        
        # 傳遞真實 IP 給後端 (對應 ClientHostMiddleware)
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 靜態檔案 (上傳的圖片)
    location /uploads/ {
        alias /app/uploads/;
        autoindex off;
    }

    # phpMyAdmin (隱藏路徑)
    location /sys_db_admin_x9zp2/ {
        proxy_pass http://phpmyadmin:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 解決 phpMyAdmin 在反向代理下的路徑問題
        proxy_redirect off;
    }
}